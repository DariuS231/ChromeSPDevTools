var SpPropertyBag=function(){function e(){this.divContainerId="divSpPropertyBag",this.divBlockContainerId="divBlockSpPropertyBag",this.reloadRequired=!1,this.refreshTableRequired=!1,this.ctx=SP.ClientContext.get_current(),this.web=this.ctx.get_web(),this.allProperties=this.web.get_allProperties(),this.ctx.load(this.web),this.ctx.load(this.allProperties);var e=Function.createDelegate(this,function(e,t){this.showPropertiesDialog(this.allProperties.get_fieldValues())}),t=Function.createDelegate(this,function(e,t){SP.UI.Notify.addNotification("Failed to get web properties...<br>"+t.get_message(),!1)});this.ctx.executeQueryAsync(e,t)}return e.prototype.toggleBlockModal=function(e){var t=document.getElementById(this.divBlockContainerId);t.style.display=e?"block":"none"},e.prototype.refreshAllPropertiesTable=function(){this.ctx=SP.ClientContext.get_current(),this.web=this.ctx.get_web(),this.allProperties=this.web.get_allProperties(),this.ctx.load(this.web),this.ctx.load(this.allProperties);var e=Function.createDelegate(this,function(e,t){this.refreshTableRequired=!1;var o=this.allProperties.get_fieldValues(),i=this.getItemArray(o),r=document.getElementById(this.divContainerId);r.innerHTML=this.buildTable(i),this.toggleBlockModal(!1)}),t=Function.createDelegate(this,function(e,t){SP.UI.Notify.addNotification("Failed to get web properties...<br>"+t.get_message(),!1)});this.ctx.executeQueryAsync(e,t)},e.prototype.buildTable=function(e){for(var t='<hr><table style="margin: 1em;">',o=0,i=e.length;o<i;o++)t+="<tr>",t+='<td style="text-align: right; padding-top: 15px;"><b>'+e[o].prop+"</b></td>",t+='<td style="padding-top: 15px;"><input id="prop'+o+'" style="width:240px; " type="text" value="'+e[o].value+'"></inpu></td>',t+='<td style="padding-top: 15px;"><button onclick="SpPropAdmin.setProperty(\''+e[o].prop+"','prop"+o+"'); return false;\">Update</button></td>",t+='<td style="padding-top: 15px;"><button style="color: red; min-width: 1em;" onclick="SpPropAdmin.deleteProperty(\''+e[o].prop+"','prop"+o+"'); return false;\">X</button></td>",t+="</tr>";return t+="</table>",t+="<hr><h3>Add a new property:</h3>",t+='<div style="margin: 1em; padding-bottom: 2em;">Key: <input id="newKey"></inpu>',t+='&nbsp;&nbsp;&nbsp;Value: <input id="newValue"></inpu>',t+='&nbsp;<button onclick="SpPropAdmin.addProperty(); return false;">Add</button></div>',t+="<div></div>",t+='<div id="'+this.divBlockContainerId+'" style="display:none; position: absolute; width: 100%; height: 100%; background-color: gray; top: 0; left: 0;opacity: .8;"></div>'},e.prototype.executeChanges=function(){this.ctx.get_web().update();var e=Function.createDelegate(this,function(e,t){console.log("Web properties successfully modified"),this.reloadRequired?window.location.reload():this.refreshTableRequired?this.refreshAllPropertiesTable():this.toggleBlockModal(!1)}),t=Function.createDelegate(this,function(e,t){SP.UI.Notify.addNotification("Failed to set web property!...<br>"+t.get_message(),!1)});this.ctx.executeQueryAsync(e,t)},e.prototype.setProperty=function(e,t){this.toggleBlockModal(!0);var o=document.getElementById(t).value;this.allProperties.set_item(e,o),this.executeChanges()},e.prototype.deleteProperty=function(e,t){if(confirm("Are you sure you want to remove this property? The page will be refreshed after the property has been deleted.")){this.toggleBlockModal(!0);var o=document.getElementById(t).parentNode.parentNode;o.parentNode.removeChild(o),this.allProperties.set_item(e),this.executeChanges(),this.reloadRequired=!0}},e.prototype.addProperty=function(){this.toggleBlockModal(!0),this.refreshTableRequired=!0;var e=document.getElementById("newKey").value,t=document.getElementById("newValue").value;document.getElementById("newValue").value="",document.getElementById("newKey").value="",this.allProperties.set_item(e,t),this.executeChanges()},e.prototype.getItemArray=function(e){var t,o,i=[];for(t in e)e.hasOwnProperty(t)&&(o=typeof e[t],"string"===o&&i.push({prop:t,value:e[t].replace(/"/g,"&quot;")}));return i.sort(function(e,t){return e.prop.localeCompare(t.prop)}),i},e.prototype.showPropertiesDialog=function(e){var t=this.getItemArray(e),o=document.createElement("div");o.id=this.divContainerId,o.innerHTML=this.buildTable(t),SP.UI.ModalDialog.showModalDialog({title:"Property Bag Editor",html:o,showClose:!0,autoSize:!0,dialogReturnValueCallback:function(e){this.reloadRequired&&window.location.reload()}})},e}();SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SpPropAdmin=new SpPropertyBag});